import sys
import os
import inspect
from flask import Flask, Blueprint

sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from db import db

app = Flask(__name__)

service_name = "{{ service_name }}"
service_bp = None

try:
    import importlib
    module = importlib.import_module(f"{service_name}.routes")
except ImportError:
    try:
        module = importlib.import_module(f"{service_name}.views")
    except ImportError as e:
        print(f"CRITICAL: Could not find 'routes.py' or 'views.py' in {service_name}")
        raise e

for name, obj in inspect.getmembers(module):
    if isinstance(obj, Blueprint):
        service_bp = obj
        print(f"‚úÖ Found Blueprint: {name}")
        break

if not service_bp:
    raise Exception(f"‚ùå No Blueprint found in {service_name}. Please define 'bp = Blueprint(...)'")

basedir = os.path.abspath(os.path.dirname(__file__))

db_url = os.environ.get('DATABASE_URL')
if db_url:
    app.config['SQLALCHEMY_DATABASE_URI'] = db_url
    print(f"üîå –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL –¥–ª—è {service_name}")
else:
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, f'{service_name}.db')
    print(f"‚ö†Ô∏è DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º SQLite –¥–ª—è {service_name}")

app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SERVICES_URLS'] = {{ services_map }}

db.init_app(app)

try:
    from api_bridge import api_bp
    app.register_blueprint(api_bp, url_prefix='/internal')
except Exception as e:
    print(f"Warning: API Bridge skipped: {e}")

app.register_blueprint(service_bp, url_prefix=f'/{service_name}')

with app.app_context():
    db.create_all()

@app.route('/health')
def health():
    return {"status": "ok", "service": service_name}

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
